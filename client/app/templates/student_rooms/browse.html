{% extends "base/layout.html" %}

{% block title %}{{ title }} - Quản lý ký túc xá{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-2">
            <i class="fas fa-bed"></i> {{ title }}
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Chọn phòng</li>
            </ol>
        </nav>
    </div>
    <div>
        <a href="{{ url_for('student_rooms.my_registrations') }}" class="btn btn-outline-primary">
            <i class="fas fa-list"></i> Đơn đăng ký của tôi
        </a>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('student_rooms.browse_rooms') }}" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">Tìm kiếm</label>
                <input type="text" class="form-control" id="search" name="search" 
                       placeholder="Tìm theo số phòng..." value="{{ filters.search or '' }}">
            </div>
            <div class="col-md-3">
                <label for="building_id" class="form-label">Tòa nhà</label>
                <select class="form-select" id="building_id" name="building_id">
                    <option value="">Tất cả tòa nhà</option>
                    {% for building in buildings %}
                    <option value="{{ building.building_id }}" 
                            {% if filters.building_id == building.building_id %}selected{% endif %}>
                        {{ building.building_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="room_type_id" class="form-label">Loại phòng</label>
                <select class="form-select" id="room_type_id" name="room_type_id">
                    <option value="">Tất cả loại phòng</option>
                    {% for room_type in room_types %}
                    <option value="{{ room_type.room_type_id }}" 
                            {% if filters.room_type_id == room_type.room_type_id %}selected{% endif %}>
                        {{ room_type.type_name }} ({{ room_type.capacity }} người)
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i> Tìm kiếm
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Room Grid -->
<div class="row" id="roomsContainer">
    {% if rooms %}
        {% for room in rooms %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card room-card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-door-open"></i> 
                        Phòng {{ room.room_number }}
                    </h5>
                    <span class="badge bg-success">Có sẵn</span>
                </div>
                <div class="card-body">
                    <div class="room-info mb-3">
                        <div class="info-row">
                            <i class="fas fa-building text-muted"></i>
                            <strong>Tòa:</strong> {{ room.building.building_name }}
                        </div>
                        <div class="info-row">
                            <i class="fas fa-users text-muted"></i>
                            <strong>Loại:</strong> {{ room.room_type.type_name }}
                        </div>
                        <div class="info-row">
                            <i class="fas fa-user-friends text-muted"></i>
                            <strong>Sức chứa:</strong> {{ room.room_type.capacity }} người
                        </div>
                        <div class="info-row">
                            <i class="fas fa-user-check text-muted"></i>
                            <strong>Hiện tại:</strong> {{ room.current_occupancy }}/{{ room.room_type.capacity }}
                        </div>
                        <div class="info-row">
                            <i class="fas fa-check-circle text-success"></i>
                            <strong>Còn trống:</strong> {{ room.available_slots }} chỗ
                        </div>
                    </div>
                    
                    <div class="price-section mb-3">
                        <div class="price">
                            <i class="fas fa-money-bill-wave text-success"></i>
                            <strong class="text-primary fs-5">{{ '{:,.0f}'.format(room.room_type.price) }} VNĐ</strong>
                            <small class="text-muted">/tháng</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    {% set registration = user_registrations.get(room.room_id) %}
                    {% if registration %}
                        {% if registration.status == 'pending' %}
                        <div class="d-grid gap-2">
                            <span class="badge bg-warning p-2">
                                <i class="fas fa-clock"></i> Đang chờ duyệt
                            </span>
                            <button class="btn btn-outline-danger btn-sm" 
                                    data-action="cancel-registration"
                                    data-registration-id="{{ registration.registration_id }}">
                                <i class="fas fa-times"></i> Hủy đăng ký
                            </button>
                        </div>
                        {% elif registration.status == 'approved' %}
                        <span class="badge bg-success p-2 w-100">
                            <i class="fas fa-check-circle"></i> Đã được duyệt
                        </span>
                        {% elif registration.status == 'rejected' %}
                        <div class="d-grid gap-2">
                            <span class="badge bg-danger p-2">
                                <i class="fas fa-times-circle"></i> Đã bị từ chối
                            </span>
                            <button class="btn btn-primary btn-sm" 
                                    data-action="register-room"
                                    data-room-id="{{ room.room_id }}"
                                    data-room-number="{{ room.room_number }}">
                                <i class="fas fa-paper-plane"></i> Đăng ký lại
                            </button>
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-info btn-sm" 
                                data-action="view-room-details"
                                data-room-id="{{ room.room_id }}">
                            <i class="fas fa-eye"></i> Xem chi tiết
                        </button>
                        <button class="btn btn-primary btn-sm" 
                                data-action="register-room"
                                data-room-id="{{ room.room_id }}"
                                data-room-number="{{ room.room_number }}">
                            <i class="fas fa-paper-plane"></i> Đăng ký phòng
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="text-center py-5">
            <i class="fas fa-bed fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">Không tìm thấy phòng nào</h4>
            <p class="text-muted">Vui lòng thử lại với bộ lọc khác</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if pagination and pagination.pages and pagination.pages > 1 %}
<nav aria-label="Room pagination">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.page - 1 }}&building_id={{ filters.building_id or '' }}&room_type_id={{ filters.room_type_id or '' }}&search={{ filters.search or '' }}">
                <i class="fas fa-chevron-left"></i> Trước
            </a>
        </li>
        {% endif %}
        
        {% for page_num in range(1, pagination.pages + 1) %}
            {% if page_num == pagination.page %}
            <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_num }}&building_id={{ filters.building_id or '' }}&room_type_id={{ filters.room_type_id or '' }}&search={{ filters.search or '' }}">
                    {{ page_num }}
                </a>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.page + 1 }}&building_id={{ filters.building_id or '' }}&room_type_id={{ filters.room_type_id or '' }}&search={{ filters.search or '' }}">
                Sau <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Room Details Modal -->
<div class="modal fade" id="roomDetailModal" tabindex="-1" aria-labelledby="roomDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roomDetailModalLabel">
                    <i class="fas fa-door-open"></i> Chi tiết phòng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="roomDetailContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Registration Confirmation Modal -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registerModalLabel">
                    <i class="fas fa-paper-plane"></i> Xác nhận đăng ký
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn đăng ký phòng <strong id="roomNumberToRegister"></strong>?</p>
                <p class="text-muted">Sau khi đăng ký, bạn cần chờ admin duyệt đơn của mình.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmRegisterBtn">
                    <i class="fas fa-paper-plane"></i> Đăng ký
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Template -->
<template id="loadingTemplate">
    <div class="text-center py-4">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Đang tải...</p>
    </div>
</template>

<!-- Room Detail Template -->
<template id="roomDetailTemplate">
    <div class="row">
        <div class="col-md-6">
            <h6><i class="fas fa-door-open"></i> Thông tin phòng</h6>
            <table class="table table-sm">
                <tr>
                    <td><strong>Số phòng:</strong></td>
                    <td>{{room_number}}</td>
                </tr>
                <tr>
                    <td><strong>Tòa nhà:</strong></td>
                    <td>{{building_name}}</td>
                </tr>
                <tr>
                    <td><strong>Loại phòng:</strong></td>
                    <td>{{room_type_name}}</td>
                </tr>
                <tr>
                    <td><strong>Sức chứa:</strong></td>
                    <td>{{capacity}} người</td>
                </tr>
                <tr>
                    <td><strong>Hiện tại:</strong></td>
                    <td>{{current_occupancy}}/{{capacity}} người</td>
                </tr>
                <tr>
                    <td><strong>Còn trống:</strong></td>
                    <td>{{available_slots}} chỗ</td>
                </tr>
            </table>
        </div>
        <div class="col-md-6">
            <h6><i class="fas fa-money-bill-wave"></i> Thông tin giá</h6>
            <table class="table table-sm">
                <tr>
                    <td><strong>Giá phòng:</strong></td>
                    <td><strong class="text-primary">{{monthly_price}} VNĐ/tháng</strong></td>
                </tr>
            </table>
            
            <h6 class="mt-3"><i class="fas fa-info-circle"></i> Mô tả</h6>
            <p class="text-muted">{{description}}</p>
        </div>
    </div>
    
    <div class="mt-3 text-center">
        <button class="btn btn-primary" 
                data-action="register-room"
                data-room-id="{{room_id}}"
                data-room-number="{{room_number}}">
            <i class="fas fa-paper-plane"></i> Đăng ký phòng này
        </button>
    </div>
</template>

{% endblock %}

{% block extra_css %}
<style>
.room-card {
    transition: transform 0.2s;
}

.room-card:hover {
    transform: translateY(-5px);
}

.info-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.info-row i {
    width: 20px;
    margin-right: 8px;
}

.price {
    display: flex;
    align-items: center;
    justify-content: center;
}

.price i {
    margin-right: 8px;
}

.badge {
    font-size: 0.9em;
}

.pagination {
    margin-top: 2rem;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/shared-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/student_rooms/room_browser.js') }}"></script>
{% endblock %}
