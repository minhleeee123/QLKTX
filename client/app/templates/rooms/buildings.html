{% extends "base/layout.html" %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Quản lý tòa nhà</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Tổng quan</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('rooms.list_rooms') }}">Quản lý phòng</a></li>
        <li class="breadcrumb-item active">Quản lý tòa nhà</li>
    </ol>
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-building me-1"></i>
                Danh sách tòa nhà
            </div>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#buildingModal">
                    <i class="fas fa-plus"></i> Thêm tòa nhà mới
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên tòa nhà</th>
                            <th>Tổng số phòng</th>
                            <th>Số phòng trống</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for building in buildings %}
                        <tr>
                            <td>{{ building.building_id }}</td>
                            <td>{{ building.building_name }}</td>
                            <td>{{ building.total_rooms }}</td>
                            <td>{{ building.available_rooms }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-primary edit-building" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#buildingModal" 
                                            data-id="{{ building.building_id }}"
                                            data-name="{{ building.building_name }}">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#deleteBuildingModal" 
                                            data-id="{{ building.building_id }}"
                                            data-name="{{ building.building_name }}">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center">Không có tòa nhà nào</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Building Modal -->
<div class="modal fade" id="buildingModal" tabindex="-1" aria-labelledby="buildingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buildingModalLabel">Thêm tòa nhà mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="buildingForm" method="POST" action="{{ url_for('rooms.create_building') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="building_id" id="building_id" value="">
                    <div class="mb-3">
                        <label for="building_name" class="form-label">Tên tòa nhà</label>
                        <input type="text" class="form-control" id="building_name" name="building_name" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Building Modal -->
<div class="modal fade" id="deleteBuildingModal" tabindex="-1" aria-labelledby="deleteBuildingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBuildingModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa tòa nhà <span id="buildingToDelete"></span>?</p>
                <p class="text-danger">Lưu ý: Việc xóa tòa nhà sẽ xóa tất cả các phòng trong tòa nhà đó!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <form id="deleteBuildingForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Xóa</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle editing building
        const buildingModal = document.getElementById('buildingModal');
        const modalTitle = buildingModal.querySelector('.modal-title');
        const buildingForm = document.getElementById('buildingForm');
        const buildingIdInput = document.getElementById('building_id');
        const buildingNameInput = document.getElementById('building_name');
        
        buildingModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const isEdit = button.classList.contains('edit-building');
            
            if (isEdit) {
                const buildingId = button.getAttribute('data-id');
                const buildingName = button.getAttribute('data-name');
                
                modalTitle.textContent = 'Chỉnh sửa tòa nhà';
                buildingIdInput.value = buildingId;
                buildingNameInput.value = buildingName;
                buildingForm.action = "{{ url_for('rooms.edit_building', building_id=0) }}".replace('0', buildingId);
            } else {
                modalTitle.textContent = 'Thêm tòa nhà mới';
                buildingIdInput.value = '';
                buildingNameInput.value = '';
                buildingForm.action = "{{ url_for('rooms.create_building') }}";
            }
        });
        
        // Handle delete building modal
        const deleteBuildingModal = document.getElementById('deleteBuildingModal');
        deleteBuildingModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const buildingId = button.getAttribute('data-id');
            const buildingName = button.getAttribute('data-name');
            
            document.getElementById('buildingToDelete').textContent = buildingName;
            document.getElementById('deleteBuildingForm').action = "{{ url_for('rooms.delete_building', building_id=0) }}".replace('0', buildingId);
        });
    });
</script>
{% endblock %}
